---
layout: page
title: 关于DR模式下设置ARP参数的原理
tags : [linux, LVS, 负载均衡, 术]
comments: true

---
{% include JB/setup %}

###概述
在LVS的DR模式下，我们通常会在RS上设置两个ARP参数，下面我们详细解析设置它们的意义。

###关于arp_ignore&ensp;&emsp;&emsp;在RS上，lo绑定了VIP，物理网卡eth0绑定自身的RIP，对外公布的只有VIP。当客户端要向VIP发送数据时，会先发送ARP请求查询VIP的MAC地址，而由于RS上绑定了VIP，所以RS会对此做出ARP响应，而显然，整个集群里，只能有Director才可以对此ARP做出响应，所以就需要阻止RS对VIP的ARP请求做出响应。我们再来看arp_announce参数的定义：
<!--summary-->	arp_ignore - INTEGER		Define different modes for sending replies in response to		received ARP requests that resolve local target IP addresses:		0 - (default): reply for any local target IP address, configured		on any interface		1 - reply only if the target IP address is local address		configured on the incoming interface		2 - reply only if the target IP address is local address		configured on the incoming interface and both with the		sender's IP address are part from same subnet on this interface		3 - do not reply for local addresses configured with scope host,		only resolutions for global and link addresses are replied		4-7 - reserved		8 - do not reply for all local addresses
		The max value from conf/{all,interface}/arp_ignore is used		when ARP request is received on the {interface}&ensp;&emsp;&emsp;如果此参数为0，那么即使是eth0接到VIP的ARP请求，它也会做出响应。将此参数配置为1，那么eth0与lo就只会对自身所绑定IP的ARP请求做出响应。由于ARP请求总是由物理网卡eth0接到，而eth0就只会响应RIP的ARP请求，而不会响应VIP的。这样就屏蔽了RS在lo上的ARP响应。
###关于arp_announce&ensp;&emsp;&emsp;在RS上，lo绑定了VIP，物理网卡eth0绑定自身的RIP。当RS通过eth0发送数据包时，使用了VIP作为数据包的源IP。而RS发送数据包时，如果本地的ARP缓存失效了，它就需要发送一个ARP请求来获取网关或者目标机器的MAC地址，而这个ARP请求里，会携带有它自己的IP和MAC，而linux默认使用数据包里的源IP作为ARP请求里的源IP，这就导致目标机器在接到ARP请求时，会使用请求里携带的VIP与MAC去刷新自己的ARP缓存。&ensp;&emsp;&emsp;但是，显然VIP只能与Director的MAC映射，而不能映射在RS上，否则下一次外部的请求就会被网关直接转发到RS上而不经过Director了。所以我们需要让RS在发送ARP请求时，携带的源IP必须是发送设备（eth0）的IP。我们再来看arp_announce参数的定义：
	arp_announce - INTEGER		Define different restriction levels for announcing the local		source IP address from IP packets in ARP requests sent on		interface:		0 - (default) Use any local address, configured on any interface		1 - Try to avoid local addresses that are not in the target's		subnet for this interface. This mode is useful when target		hosts reachable via this interface require the source IP		address in ARP requests to be part of their logical network		configured on the receiving interface. When we generate the		request we will check all our subnets that include the		target IP and will preserve the source address if it is from		such subnet. If there is no such subnet we select source		address according to the rules for level 2.		2 - Always use the best local address for this target.		In this mode we ignore the source address in the IP packet		and try to select local address that we prefer for talks with		the target host. Such local address is selected by looking		for primary IP addresses on all our subnets on the outgoing		interface that include the target IP address. If no suitable		local address is found we select the first local address		we have on the outgoing interface or on all other interfaces,		with the hope we will receive reply for our request and		even sometimes no matter the source IP address we announce.		The max value from conf/{all,interface}/arp_announce is used.		Increasing the restriction level gives more chance for		receiving answer from the resolved target while decreasing		the level announces more valid sender's information.当参数设置为2时，ARP请求会忽略数据包的源IP，而使用发送设备的IP。